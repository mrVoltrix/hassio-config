light_start_dimmer:
  sequence:
    - service_template: >
        {% if state_attr('light.ikea_bulb_1', 'brightness')|default(1)|int < states('input_number.light_maximum')|int %}
          script.turn_on
        {% endif %}
      data:
        entity_id: script.light_brighten
    - service_template: >
        {% if state_attr('light.ikea_bulb_1', 'brightness')|default(1)|int >= states('input_number.light_maximum')|int %}
          script.turn_on
        {% endif %}
      data:
        entity_id: script.light_darken

light_stop_dimmer:
  sequence:
    - service: script.turn_off
      data:
        entity_id: 
          - script.light_brighten
          - script.light_darken
          - script.light_brighten_pause
          - script.light_darken_pause

light_brighten:
  sequence:
    - service: light.turn_on
      data_template:
        entity_id: light.ikea_bulb_1
        brightness: >-
          {% set current = state_attr('light.ikea_bulb_1', 'brightness')|default(1)|int %}
          {% set step = states('input_number.light_step')|int %}
          {% set next = current + step %}
          {% if next > states('input_number.light_maximum')|int %}
            {% set next = states('input_number.light_maximum')|int %}
          {% endif %}
          {{ next }}
    - service_template: >
        {% if state_attr('light.ikea_bulb_1', 'brightness')|default(1)|int < states('input_number.light_maximum')|int %}
          script.turn_on
        {% else %}
          script.turn_off
        {% endif %}
      data:
        entity_id: script.light_brighten_pause
    - service_template: >
        {% if state_attr('light.ikea_bulb_1', 'brightness')|default(1)|int >= states('input_number.light_maximum')|int %}
          script.turn_on
        {% endif %}
      data:
        entity_id: script.light_darken_pause

light_brighten_pause:
  sequence:
    - delay:
        milliseconds: 1
    - service: script.turn_on
      data:
        entity_id: script.light_brighten

light_darken:
  sequence:
    - service: light.turn_on
      data_template:
        entity_id: light.ikea_bulb_1
        brightness: >-
          {% set current = state_attr('light.ikea_bulb_1', 'brightness')|default(1)|int %}
          {% set step = states('input_number.light_step')|int %}
          {% set next = current - step %}
          {% if next < states('input_number.light_minimum')|int %}
            {% set next = states('input_number.light_minimum')|int %}
          {% endif %}
          {{ next }}

    - service_template: >
        {% if state_attr('light.ikea_bulb_1', 'brightness')|default(1)|int > states('input_number.light_minimum')|int %}
          script.turn_on
        {% else %}
          script.turn_off
        {% endif %}
      data:
        entity_id: script.light_darken_pause
    - service_template: >
        {% if state_attr('light.ikea_bulb_1', 'brightness')|default(1)|int <= states('input_number.light_minimum')|int %}
          script.turn_on
        {% endif %}
      data:
        entity_id: script.light_brighten_pause

light_darken_pause:
  sequence:
    - delay:
        milliseconds: 1
    - service: script.turn_on
      data:
        entity_id: script.light_darken